
// This file was autogenerated by go-to-protobuf. Do not edit it manually!

syntax = 'proto2';

package github.com.openshift.api.kubecontrolplane.v1;

import "github.com/openshift/api/config/v1/generated.proto";
import "github.com/openshift/api/osin/v1/generated.proto";
import "k8s.io/apimachinery/pkg/apis/meta/v1/generated.proto";
import "k8s.io/apimachinery/pkg/runtime/schema/generated.proto";
import "k8s.io/apimachinery/pkg/util/intstr/generated.proto";

// Package-wide variables from generator "generated".
option go_package = "v1";

// AggregatorConfig holds information required to make the aggregator function.
message AggregatorConfig {
  // proxyClientInfo specifies the client cert/key to use when proxying to aggregated API servers
  optional github.com.openshift.api.config.v1.CertInfo proxyClientInfo = 1;
}

// Arguments masks the value so protobuf can generate
// +protobuf.nullable=true
// +protobuf.options.(gogoproto.goproto_stringer)=false
message Arguments {
  // items, if empty, will result in an empty slice

  repeated string items = 1;
}

message KubeAPIServerConfig {
  // provides the standard apiserver configuration
  optional github.com.openshift.api.config.v1.GenericAPIServerConfig genericAPIServerConfig = 1;

  // authConfig configures authentication options in addition to the standard
  // oauth token and client certificate authenticators
  optional MasterAuthConfig authConfig = 2;

  // aggregatorConfig has options for configuring the aggregator component of the API server.
  optional AggregatorConfig aggregatorConfig = 3;

  // kubeletClientInfo contains information about how to connect to kubelets
  optional KubeletConnectionInfo kubeletClientInfo = 4;

  // servicesSubnet is the subnet to use for assigning service IPs
  optional string servicesSubnet = 5;

  // servicesNodePortRange is the range to use for assigning service public ports on a host.
  optional string servicesNodePortRange = 6;

  // consolePublicURL is an optional URL to provide a redirect from the kube-apiserver to the webconsole
  optional string consolePublicURL = 15;

  // UserAgentMatchingConfig controls how API calls from *voluntarily* identifying clients will be handled.  THIS DOES NOT DEFEND AGAINST MALICIOUS CLIENTS!
  // TODO I think we should just drop this feature.
  optional UserAgentMatchingConfig userAgentMatchingConfig = 8;

  // imagePolicyConfig feeds the image policy admission plugin
  // TODO make it an admission plugin config
  optional KubeAPIServerImagePolicyConfig imagePolicyConfig = 9;

  // projectConfig feeds an admission plugin
  // TODO make it an admission plugin config
  optional KubeAPIServerProjectConfig projectConfig = 10;

  // serviceAccountPublicKeyFiles is a list of files, each containing a PEM-encoded public RSA key.
  // (If any file contains a private key, the public portion of the key is used)
  // The list of public keys is used to verify presented service account tokens.
  // Each key is tried in order until the list is exhausted or verification succeeds.
  // If no keys are specified, no service account authentication will be available.
  repeated string serviceAccountPublicKeyFiles = 11;

  // oauthConfig, if present start the /oauth endpoint in this process
  optional github.com.openshift.api.osin.v1.OAuthConfig oauthConfig = 13;

  // TODO this needs to be removed.
  map<string, Arguments> apiServerArguments = 14;
}

message KubeAPIServerImagePolicyConfig {
  // internalRegistryHostname sets the hostname for the default internal image
  // registry. The value must be in "hostname[:port]" format.
  // For backward compatibility, users can still use OPENSHIFT_DEFAULT_REGISTRY
  // environment variable but this setting overrides the environment variable.
  optional string internalRegistryHostname = 1;

  // externalRegistryHostname sets the hostname for the default external image
  // registry. The external hostname should be set only when the image registry
  // is exposed externally. The value is used in 'publicDockerImageRepository'
  // field in ImageStreams. The value must be in "hostname[:port]" format.
  optional string externalRegistryHostname = 2;
}

message KubeAPIServerProjectConfig {
  // defaultNodeSelector holds default project node label selector
  optional string defaultNodeSelector = 1;
}

// KubeletConnectionInfo holds information necessary for connecting to a kubelet
message KubeletConnectionInfo {
  // port is the port to connect to kubelets on
  optional uint32 port = 1;

  // ca is the CA for verifying TLS connections to kubelets
  optional string ca = 2;

  // CertInfo is the TLS client cert information for securing communication to kubelets
  // this is anonymous so that we can inline it for serialization
  optional github.com.openshift.api.config.v1.CertInfo certInfo = 3;
}

// MasterAuthConfig configures authentication options in addition to the standard
// oauth token and client certificate authenticators
message MasterAuthConfig {
  // requestHeader holds options for setting up a front proxy against the the API.  It is optional.
  optional RequestHeaderAuthenticationOptions requestHeader = 1;

  // webhookTokenAuthenticators, if present configures remote token reviewers
  repeated WebhookTokenAuthenticator webhookTokenAuthenticators = 2;

  // oauthMetadataFile is a path to a file containing the discovery endpoint for OAuth 2.0 Authorization
  // Server Metadata for an external OAuth server.
  // See IETF Draft: // https://tools.ietf.org/html/draft-ietf-oauth-discovery-04#section-2
  // This option is mutually exclusive with OAuthConfig
  optional string oauthMetadataFile = 3;
}

// RequestHeaderAuthenticationOptions provides options for setting up a front proxy against the entire
// API instead of against the /oauth endpoint.
message RequestHeaderAuthenticationOptions {
  // clientCA is a file with the trusted signer certs.  It is required.
  optional string clientCA = 1;

  // clientCommonNames is a required list of common names to require a match from.
  repeated string clientCommonNames = 2;

  // usernameHeaders is the list of headers to check for user information.  First hit wins.
  repeated string usernameHeaders = 3;

  // groupHeaders is the set of headers to check for group information.  All are unioned.
  repeated string groupHeaders = 4;

  // extraHeaderPrefixes is the set of request header prefixes to inspect for user extra. X-Remote-Extra- is suggested.
  repeated string extraHeaderPrefixes = 5;
}

// UserAgentDenyRule adds a rejection message that can be used to help a user figure out how to get an approved client
message UserAgentDenyRule {
  optional UserAgentMatchRule userAgentMatchRule = 1;

  // RejectionMessage is the message shown when rejecting a client.  If it is not a set, the default message is used.
  optional string rejectionMessage = 2;
}

// UserAgentMatchRule describes how to match a given request based on User-Agent and HTTPVerb
message UserAgentMatchRule {
  // regex is a regex that is checked against the User-Agent.
  // Known variants of oc clients
  // 1. oc accessing kube resources: oc/v1.2.0 (linux/amd64) kubernetes/bc4550d
  // 2. oc accessing openshift resources: oc/v1.1.3 (linux/amd64) openshift/b348c2f
  // 3. openshift kubectl accessing kube resources:  openshift/v1.2.0 (linux/amd64) kubernetes/bc4550d
  // 4. openshift kubectl accessing openshift resources: openshift/v1.1.3 (linux/amd64) openshift/b348c2f
  // 5. oadm accessing kube resources: oadm/v1.2.0 (linux/amd64) kubernetes/bc4550d
  // 6. oadm accessing openshift resources: oadm/v1.1.3 (linux/amd64) openshift/b348c2f
  // 7. openshift cli accessing kube resources: openshift/v1.2.0 (linux/amd64) kubernetes/bc4550d
  // 8. openshift cli accessing openshift resources: openshift/v1.1.3 (linux/amd64) openshift/b348c2f
  optional string regex = 1;

  // httpVerbs specifies which HTTP verbs should be matched.  An empty list means "match all verbs".
  repeated string httpVerbs = 2;
}

// UserAgentMatchingConfig controls how API calls from *voluntarily* identifying clients will be handled.  THIS DOES NOT DEFEND AGAINST MALICIOUS CLIENTS!
message UserAgentMatchingConfig {
  // requiredClients if this list is non-empty, then a User-Agent must match one of the UserAgentRegexes to be allowed
  repeated UserAgentMatchRule requiredClients = 1;

  // deniedClients if this list is non-empty, then a User-Agent must not match any of the UserAgentRegexes
  repeated UserAgentDenyRule deniedClients = 2;

  // defaultRejectionMessage is the message shown when rejecting a client.  If it is not a set, a generic message is given.
  optional string defaultRejectionMessage = 3;
}

// WebhookTokenAuthenticators holds the necessary configuation options for
// external token authenticators
message WebhookTokenAuthenticator {
  // configFile is a path to a Kubeconfig file with the webhook configuration
  optional string configFile = 1;

  // cacheTTL indicates how long an authentication result should be cached.
  // It takes a valid time duration string (e.g. "5m").
  // If empty, you get a default timeout of 2 minutes.
  // If zero (e.g. "0m"), caching is disabled
  optional string cacheTTL = 2;
}

